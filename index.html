<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Pajak Pro - Archisight Nusantara</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .table-responsive { overflow-x: auto; }
        .form-input, .form-select {
            border: 1px solid #d1d5db; transition: all 0.2s ease-in-out; padding: 0.5rem; border-radius: 0.375rem; width: 100%;
        }
        .form-input:focus, .form-select:focus { border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); }
        .input-table td { padding: 0.5rem 0.4rem; vertical-align: middle; }
        .delete-btn { background-color: transparent; border: none; cursor: pointer; padding: 0.5rem; color: #9ca3af; transition: color 0.2s; }
        .delete-btn:hover { color: #ef4444; }
        .btn-primary { background-image: linear-gradient(to right, #4f46e5, #6366f1); transition: all 0.3s ease; box-shadow: 0 4px 15px 0 rgba(79, 70, 229, 0.3); }
        .btn-primary:hover { box-shadow: 0 6px 20px 0 rgba(79, 70, 229, 0.4); transform: translateY(-1px); }
        #input-table-unifikasi tbody tr:nth-child(even) { background-color: #f9fafb; }
        .tab-btn {
            padding: 0.75rem 1.5rem; border-bottom: 3px solid transparent; transition: all 0.3s; font-weight: 600; color: #6b7280;
        }
        .tab-btn.active {
            color: #4f46e5; border-bottom-color: #4f46e5;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .sub-tab-btn { transition: all 0.2s ease-in-out; color: #4b5563; }
        .sub-tab-btn.active { background-color: white; color: #4f46e5; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .result-item { display: flex; justify-content: space-between; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 0.5rem;}
        .app-header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            padding: 1rem; /* Reduced padding */
            border-radius: 0.75rem;
            color: white;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .donation-amount-btn {
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .donation-amount-btn.selected {
            border-color: #4f46e5;
            background-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="app-header relative text-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Archisight Tax Assistant</h1>
            <p class="text-sm sm:text-base text-gray-300 mt-1">Kalkulator Pajak Profesional untuk Bisnis Anda</p>
        </header>
        
        <div class="border-b border-gray-200 mb-6">
            <nav class="flex flex-wrap justify-center -mb-px" aria-label="Tabs">
                <button class="tab-btn active" data-tab="unifikasi">Kalkulator PPh Unifikasi</button>
                <button class="tab-btn" data-tab="pph21">Kalkulator PPh 21</button>
                <button class="tab-btn" data-tab="ter">Daftar TER</button>
                <button class="tab-btn" data-tab="donasi">Beliin Kopi</button>
            </nav>
        </div>

        <!-- Tab Content: PPh Unifikasi -->
        <div id="unifikasi-content" class="tab-content active">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Input Transaksi PPh Unifikasi</h3>
                <div class="table-responsive">
                    <table class="min-w-full input-table" id="input-table-unifikasi">
                        <thead class="border-b-2 border-gray-200">
                            <tr>
                                <th class="py-2 px-2 text-left text-sm font-semibold text-gray-600 w-12">No</th>
                                <th class="py-2 px-2 text-left text-sm font-semibold text-gray-600 min-w-[150px]">Nomor Invoice</th>
                                <th class="py-2 px-2 text-left text-sm font-semibold text-gray-600 min-w-[150px]">Nama Perusahaan</th>
                                <th class="py-2 px-2 text-left text-sm font-semibold text-gray-600 min-w-[220px]">Jenis Pajak</th>
                                <th class="py-2 px-2 text-left text-sm font-semibold text-gray-600 min-w-[120px]">Tarif PPh (%)</th>
                                <th class="py-2 px-2 text-left text-sm font-semibold text-gray-600 min-w-[160px]">DPP</th>
                                <th class="py-2 px-2 text-left text-sm font-semibold text-gray-600 min-w-[210px]">Opsi PPN</th>
                                <th class="py-2 px-2 text-center text-sm font-semibold text-gray-600">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-rows-container-unifikasi"></tbody>
                    </table>
                </div>
                <button id="add-row-btn-unifikasi" class="mt-4 bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200">+ Tambah Baris</button>
            </div>
            <div class="mt-8 text-center"><button id="calculateBtn-unifikasi" class="w-full max-w-md btn-primary text-white font-bold py-3 px-4 rounded-lg text-lg">Hitung Pajak Unifikasi</button></div>
            <div id="error-container-unifikasi" class="mt-6 text-center"></div>
            <div id="result-container-unifikasi" class="mt-8 bg-white p-6 rounded-xl shadow-lg hidden">
                <h2 class="text-2xl font-bold mb-4">Hasil Perhitungan PPh Unifikasi</h2>
                <div class="table-responsive">
                    <table class="min-w-full divide-y divide-gray-200" id="result-table-unifikasi"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">No. Invoice</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Perusahaan</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Deskripsi</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">DPP</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">PPN</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">PPh</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Jumlah</th></tr></thead><tbody id="result-table-body-unifikasi" class="divide-y divide-gray-200"></tbody><tfoot id="result-table-foot-unifikasi" class="bg-gray-100 font-bold"></tfoot></table>
                </div>
                <div id="export-buttons-unifikasi" class="mt-6 flex flex-col sm:flex-row justify-end gap-3"><button id="export-excel-btn-unifikasi" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">Ekspor ke Excel</button><button id="export-pdf-btn-unifikasi" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">Ekspor ke PDF</button></div>
            </div>
        </div>

        <!-- Tab Content: PPh 21 -->
        <div id="pph21-content" class="tab-content">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Kalkulator PPh 21 (PP-58/2023 & PMK-168/2023)</h3>
                <div class="mb-6 flex justify-center border-b border-gray-200">
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button class="pph21-sub-tab-btn active px-4 py-2 text-sm font-semibold rounded-md" data-subtab="bulanan">Bulanan (TER)</button>
                        <button class="pph21-sub-tab-btn px-4 py-2 text-sm font-semibold rounded-md" data-subtab="akhirtahun">Masa Pajak Terakhir</button>
                    </div>
                </div>
                <div id="pph21-bulanan-content" class="pph21-sub-tab-content active">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div class="space-y-4 p-4 border rounded-lg">
                                <h4 class="text-lg font-semibold border-b pb-2">Data Personal</h4>
                                <div><label for="status-pegawai" class="block text-sm font-medium text-gray-700">Status Pegawai</label><select id="status-pegawai" class="form-select mt-1"><option>Pegawai Tetap</option><option>Pensiunan</option></select></div>
                                <div><label for="ptkp-status-bulanan" class="block text-sm font-medium text-gray-700">Status Kawin & Tanggungan</label><select id="ptkp-status-bulanan" class="form-select mt-1"></select></div>
                                <div><label class="block text-sm font-medium text-gray-700">Metode Tunjangan Pajak</label><div class="mt-2 flex gap-4"><label class="inline-flex items-center"><input type="radio" name="tax-method" value="gross" checked> <span class="ml-2">Gross</span></label><label class="inline-flex items-center"><input type="radio" name="tax-method" value="gross-up"> <span class="ml-2">Gross-up</span></label></div></div>
                            </div>
                            <div class="space-y-4 p-4 border rounded-lg">
                                <h4 class="text-lg font-semibold border-b pb-2">A. Penghasilan</h4>
                                <div class="grid grid-cols-2 gap-4 items-center">
                                    <label class="text-sm font-medium">Gaji/Pensiun atau THT/JHT</label><input type="number" id="gaji" class="form-input p21-income" placeholder="0">
                                    <label class="text-sm font-medium">Tunjangan PPh</label><input type="number" id="tunjangan-pph" class="form-input p21-income" placeholder="0">
                                    <label class="text-sm font-medium">Tunjangan Lainnya, Lembur, dsb.</label><input type="number" id="tunjangan-lain" class="form-input p21-income" placeholder="0">
                                    <label class="text-sm font-medium">Honorarium & Imbalan Lain</label><input type="number" id="honorarium" class="form-input p21-income" placeholder="0">
                                    <label class="text-sm font-medium">Premi Asuransi (oleh Pemberi Kerja)</label><input type="number" id="premi-asuransi" class="form-input p21-income" placeholder="0">
                                    <label class="text-sm font-medium">Natura & Kenikmatan Lainnya</label><input type="number" id="natura" class="form-input p21-income" placeholder="0">
                                    <label class="text-sm font-medium">Tantiem, Bonus, Gratifikasi, THR</label><input type="number" id="bonus" class="form-input p21-income" placeholder="0">
                                    <label class="text-sm font-bold">Penghasilan Bruto</label><input type="number" id="penghasilan-bruto-bulanan" class="form-input bg-gray-100 font-bold" disabled>
                                </div>
                            </div>
                            <div class="flex gap-4"><button id="resetBtn-pph21-bulanan" class="w-1/2 bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg">Reset</button><button id="calculateBtn-pph21-bulanan" class="w-1/2 btn-primary text-white font-bold py-2 px-4 rounded-lg">Hitung</button></div>
                        </div>
                        <div class="space-y-6 lg:col-start-2">
                            <div id="result-pph21-bulanan" class="p-4 bg-white border rounded-lg sticky top-6"><h4 class="text-lg font-semibold border-b pb-2 mb-4">B. Penghitungan PPh Pasal 21</h4><div class="text-center text-gray-500">Hasil perhitungan akan muncul di sini.</div></div>
                            <div class="p-4 bg-white border rounded-lg">
                                <h4 class="text-lg font-semibold mb-3">Kalkulasi Massal</h4>
                                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                                    <h5 class="font-bold mb-2">Cara Menggunakan Fitur Impor:</h5>
                                    <ol class="list-decimal list-inside space-y-1">
                                        <li><strong>Unduh Template:</strong> Klik tombol "Unduh Template" untuk mendapatkan file Excel.</li>
                                        <li><strong>Isi Data:</strong> Buka file dan isi data karyawan sesuai kolom yang tersedia. Gunakan sheet "Referensi PTKP" untuk kode status yang benar.</li>
                                        <li><strong>Impor File:</strong> Klik "Impor dari Excel" dan pilih file yang sudah Anda isi.</li>
                                        <li><strong>Ekspor Hasil:</strong> Setelah hasil perhitungan muncul di bawah, Anda bisa mengekspornya ke dalam file Excel baru.</li>
                                    </ol>
                                </div>
                                <div class="flex flex-col sm:flex-row justify-center gap-4">
                                    <button id="template-excel-btn-pph21" class="text-sm bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex-1">Unduh Template</button>
                                    <label for="import-excel-pph21" class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer flex-1 text-center">Impor dari Excel</label>
                                    <input type="file" id="import-excel-pph21" class="hidden" accept=".xlsx, .xls">
                                </div>
                            </div>
                            <div id="import-result-pph21" class="hidden"><h4 class="text-lg font-semibold mb-2">Hasil Impor Data</h4><div class="table-responsive max-h-80 border rounded-lg"><table class="min-w-full text-sm whitespace-nowrap"></table></div><button id="export-excel-btn-pph21" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Ekspor Hasil ke Excel</button></div>
                        </div>
                    </div>
                </div>
                <div id="pph21-akhirtahun-content" class="pph21-sub-tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Left Column: Inputs -->
                        <div class="space-y-6">
                            <!-- A. Informasi Pegawai -->
                            <div class="space-y-4 p-4 border rounded-lg">
                                <h4 class="text-lg font-semibold border-b pb-2">A. Informasi Pegawai</h4>
                                <div><label for="status-pegawai-tahunan" class="block text-sm font-medium text-gray-700">Status Pegawai</label><select id="status-pegawai-tahunan" class="form-select mt-1"><option value="tetap">Pegawai Tetap</option><option value="pensiunan">Pensiunan</option></select></div>
                                <div><label for="status-kawin-tahunan" class="block text-sm font-medium text-gray-700">Status Perkawinan</label><select id="status-kawin-tahunan" class="form-select mt-1"><option value="TK">Tidak Kawin</option><option value="K">Kawin</option><option value="KI">Kawin (Penghasilan Istri Digabung)</option></select></div>
                                <div><label for="tanggungan-tahunan" class="block text-sm font-medium text-gray-700">Jumlah Tanggungan</label><input type="number" id="tanggungan-tahunan" class="form-input mt-1" min="0" max="3" value="0"></div>
                            </div>
                
                            <!-- B. Penghasilan Bruto Setahun -->
                            <div class="space-y-4 p-4 border rounded-lg">
                                 <h4 class="text-lg font-semibold border-b pb-2">B. Penghasilan Bruto Setahun</h4>
                                 <div class="grid grid-cols-2 gap-x-4 gap-y-2 items-center">
                                    <label class="text-sm font-medium">Gaji/Pensiun Setahun</label><input type="number" id="gaji-tahunan" class="form-input p21-income-tahunan" placeholder="0">
                                    <label class="text-sm font-medium">Tunjangan PPh</label><input type="number" id="tunjangan-pph-tahunan" class="form-input p21-income-tahunan" placeholder="0">
                                    <label class="text-sm font-medium">Tunjangan Lainnya, Uang Lembur, dll.</label><input type="number" id="tunjangan-lain-tahunan" class="form-input p21-income-tahunan" placeholder="0">
                                    <label class="text-sm font-medium">Honorarium dan Imbalan Sejenis</label><input type="number" id="honorarium-tahunan" class="form-input p21-income-tahunan" placeholder="0">
                                    <label class="text-sm font-medium">Premi Asuransi</label><input type="number" id="premi-asuransi-tahunan" class="form-input p21-income-tahunan" placeholder="0">
                                    <label class="text-sm font-medium">Natura & Kenikmatan</label><input type="number" id="natura-tahunan" class="form-input p21-income-tahunan" placeholder="0">
                                    <label class="text-sm font-medium">Bonus, THR, dsb.</label><input type="number" id="bonus-tahunan" class="form-input p21-income-tahunan" placeholder="0">
                                    <label class="text-sm font-bold">Total Penghasilan Bruto</label><input type="text" id="total-bruto-tahunan" class="form-input bg-gray-100 font-bold" disabled>
                                 </div>
                            </div>
                
                            <!-- C. Pengurang -->
                            <div class="space-y-4 p-4 border rounded-lg">
                                <h4 class="text-lg font-semibold border-b pb-2">C. Pengurang</h4>
                                <div class="grid grid-cols-2 gap-x-4 gap-y-2 items-center">
                                    <label class="text-sm font-medium">Iuran Pensiun / THT / JHT</label><input type="number" id="iuran-pensiun-tahunan" class="form-input p21-pengurang-tahunan" placeholder="0">
                                    <label class="text-sm font-medium">Zakat/Sumbangan Wajib</label><input type="number" id="zakat-tahunan" class="form-input p21-pengurang-tahunan" placeholder="0">
                                    <label class="text-sm font-medium">Biaya Jabatan/Pensiun</label><input type="text" id="biaya-jabatan-pensiun-tahunan" class="form-input bg-gray-100" disabled>
                                    <label class="text-sm font-bold">Jumlah Pengurang</label><input type="text" id="total-pengurang-tahunan" class="form-input bg-gray-100 font-bold" disabled>
                                </div>
                            </div>
                
                            <!-- D. PPh 21 Telah Dipotong -->
                            <div class="space-y-4 p-4 border rounded-lg">
                                 <h4 class="text-lg font-semibold border-b pb-2">D. PPh 21 Telah Dipotong</h4>
                                 <div><label for="pph21-dipotong-sebelumnya" class="block text-sm font-medium text-gray-700">Total PPh 21 dipotong (Jan - Nov)</label><input type="number" id="pph21-dipotong-sebelumnya" class="form-input mt-1" placeholder="0"></div>
                            </div>
                            
                            <div id="error-container-pph21-tahunan" class="my-4"></div>
                            <div class="flex gap-4"><button id="resetBtn-pph21-tahunan" class="w-1/2 bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg">Reset</button><button id="calculateBtn-pph21-tahunan" class="w-1/2 btn-primary text-white font-bold py-2 px-4 rounded-lg">Hitung</button></div>
                        </div>
                
                        <!-- Right Column: Results -->
                        <div id="result-pph21-akhirtahun" class="p-4 bg-white border rounded-lg sticky top-6">
                            <h4 class="text-lg font-semibold border-b pb-2 mb-4">E. Hasil Perhitungan</h4>
                            <div class="text-center text-gray-500">Hasil perhitungan akan muncul di sini.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Content: Daftar TER -->
        <div id="ter-content" class="tab-content">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-2 text-gray-800">Penjelasan Tarif Efektif Rata-rata (TER)</h3>
                <p class="text-gray-600 mb-6">Sesuai Peraturan Pemerintah Nomor 58 Tahun 2023, Tarif Efektif Rata-rata (TER) digunakan untuk menyederhanakan perhitungan PPh Pasal 21 bagi pegawai tetap dan pensiunan untuk masa pajak selain Masa Pajak Terakhir (Januari - November). Tarif ditentukan berdasarkan Penghasilan Kena Pajak (PTKP) Wajib Pajak.</p>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2">Kategori TER</h4>
                    <ul class="list-disc list-inside space-y-1 text-gray-600">
                        <li><b>Kategori A:</b> Untuk Wajib Pajak dengan status PTKP TK/0, TK/1, dan K/0.</li>
                        <li><b>Kategori B:</b> Untuk Wajib Pajak dengan status PTKP TK/2, TK/3, K/1, dan K/2.</li>
                        <li><b>Kategori C:</b> Untuk Wajib Pajak dengan status PTKP K/3.</li>
                    </ul>
                </div>
                <div class="mb-6 p-4 border-l-4 border-yellow-400 bg-yellow-50">
                    <h4 class="text-lg font-semibold mb-2 text-yellow-800">Contoh Kasus</h4>
                    <p class="text-yellow-700">Tuan Budi (status K/1, menikah dengan 1 tanggungan) memiliki penghasilan bruto sebulan sebesar Rp 10.000.000. Berapa PPh 21 yang harus dipotong?</p>
                    <ol class="list-decimal list-inside mt-2 text-yellow-700 space-y-1">
                        <li><b>Tentukan Kategori:</b> Status K/1 masuk ke dalam <b>Kategori B</b>.</li>
                        <li><b>Cari Tarif di Tabel TER B:</b> Penghasilan Rp 10.000.000 berada di rentang Rp 8.850.001 s.d. Rp 10.200.000. Tarif TER yang berlaku adalah <b>1.50%</b>.</li>
                        <li><b>Hitung PPh 21:</b> Rp 10.000.000 x 1.50% = <b>Rp 150.000</b>.</li>
                    </ol>
                </div>
                <div class="mb-6 flex justify-center border-b border-gray-200">
                    <div class="flex bg-gray-100 p-1 rounded-lg">
                        <button class="sub-tab-btn active px-4 py-2 text-sm font-semibold rounded-md" data-tertab="A">TER A</button>
                        <button class="sub-tab-btn px-4 py-2 text-sm font-semibold rounded-md" data-tertab="B">TER B</button>
                        <button class="sub-tab-btn px-4 py-2 text-sm font-semibold rounded-md" data-tertab="C">TER C</button>
                        <button class="sub-tab-btn px-4 py-2 text-sm font-semibold rounded-md" data-tertab="Harian">TER Harian</button>
                    </div>
                </div>
                <div id="ter-tables-container"></div>
            </div>
        </div>

        <!-- Tab Content: Donasi -->
        <div id="donasi-content" class="tab-content">
             <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto text-center">
                <h3 class="text-2xl font-bold mt-4 text-gray-800">Dukung Pengembangan Aplikasi</h3>
                <p class="text-gray-600 mt-2 mb-6">Jika Anda merasa aplikasi ini bermanfaat dan ingin mendukung pengembangan fitur-fitur baru di masa depan, Anda bisa memberikan apresiasi dengan mentraktir saya secangkir kopi.</p>
                <div class="mb-4">
                    <label for="donation-amount" class="block text-sm font-medium text-gray-700 mb-1">Nominal (Rp)</label>
                    <input type="number" id="donation-amount" class="form-input text-center text-lg" placeholder="Ketik Jumlah Dukungan">
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                    <button class="donation-amount-btn p-2 rounded-lg" data-amount="5000">5k</button>
                    <button class="donation-amount-btn p-2 rounded-lg" data-amount="18000">18k</button>
                    <button class="donation-amount-btn p-2 rounded-lg" data-amount="25000">25k</button>
                    <button class="donation-amount-btn p-2 rounded-lg" data-amount="100000">100k</button>
                </div>
                 <div class="mb-4">
                    <label for="donation-name" class="block text-sm font-medium text-gray-700 mb-1">Dari</label>
                    <input type="text" id="donation-name" class="form-input" placeholder="Nama Anda (Opsional)">
                </div>
                 <div class="mb-6">
                    <label for="donation-message" class="block text-sm font-medium text-gray-700 mb-1">Pesan</label>
                    <textarea id="donation-message" rows="3" class="form-input" placeholder="Tulis pesan dukungan..."></textarea>
                </div>
                <div id="donation-error-container" class="my-4"></div>
                <button id="donate-btn" class="w-full btn-primary text-white font-bold py-3 px-8 rounded-lg text-lg">
                    Lanjutkan Pembayaran
                </button>
            </div>
        </div>
    </div>

    <script>
    // --- MAIN SCRIPT ---
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- DATA & HELPER FUNCTIONS ---
        const formatNumber = (num) => new Intl.NumberFormat('id-ID').format(Math.round(num));
        function showError(containerId, message) {
            const errorContainer = document.getElementById(containerId);
            if(errorContainer) errorContainer.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">${message}</div>`;
        }
        function clearError(containerId) {
            const errorContainer = document.getElementById(containerId);
            if(errorContainer) errorContainer.innerHTML = '';
        }
        
        // --- PPh 21 DATA ---
        const ptkpRates = {
            'TK0': { ptkp: 54000000, category: 'A' }, 'TK1': { ptkp: 58500000, category: 'A' },
            'TK2': { ptkp: 63000000, category: 'B' }, 'TK3': { ptkp: 67500000, category: 'B' },
            'K0': { ptkp: 58500000, category: 'A' }, 'K1': { ptkp: 63000000, category: 'B' },
            'K2': { ptkp: 67500000, category: 'B' }, 'K3': { ptkp: 72000000, category: 'C' },
            'KI0': { ptkp: 112500000, category: 'C' }, 'KI1': { ptkp: 117000000, category: 'C' },
            'KI2': { ptkp: 121500000, category: 'C' }, 'KI3': { ptkp: 126000000, category: 'C' }
        };
        const ter_A = [ { from: 0, to: 5400000, rate: 0 }, { from: 5400001, to: 5650000, rate: 0.0025 }, { from: 5650001, to: 5950000, rate: 0.005 }, { from: 5950001, to: 6300000, rate: 0.0075 }, { from: 6300001, to: 6750000, rate: 0.01 }, { from: 6750001, to: 7500000, rate: 0.0125 }, { from: 7500001, to: 8550000, rate: 0.015 }, { from: 8550001, to: 9650000, rate: 0.0175 }, { from: 9650001, to: 10700000, rate: 0.02 }, { from: 10700001, to: 11600000, rate: 0.0225 }, { from: 11600001, to: 12500000, rate: 0.025 }, { from: 12500001, to: 13400000, rate: 0.03 }, { from: 13400001, to: 14500000, rate: 0.04 }, { from: 14500001, to: 15800000, rate: 0.05 }, { from: 15800001, to: 17400000, rate: 0.06 }, { from: 17400001, to: 19400000, rate: 0.07 }, { from: 19400001, to: 21800000, rate: 0.08 }, { from: 21800001, to: 24700000, rate: 0.09 }, { from: 24700001, to: 27900000, rate: 0.1 }, { from: 27900001, to: 31600000, rate: 0.11 }, { from: 31600001, to: 35700000, rate: 0.12 }, { from: 35700001, to: 40500000, rate: 0.13 }, { from: 40500001, to: 45800000, rate: 0.14 }, { from: 45800001, to: 53800000, rate: 0.15 }, { from: 53800001, to: 64000000, rate: 0.16 }, { from: 64000001, to: 75000000, rate: 0.17 }, { from: 7500001, to: 88000000, rate: 0.18 }, { from: 8800001, to: 103000000, rate: 0.19 }, { from: 103000001, to: 120000000, rate: 0.2 }, { from: 120000001, to: 140000000, rate: 0.21 }, { from: 140000001, to: 164000000, rate: 0.22 }, { from: 16400001, to: 195000000, rate: 0.23 }, { from: 195000001, to: 230000000, rate: 0.24 }, { from: 230000001, to: 270000000, rate: 0.25 }, { from: 270000001, to: 322000000, rate: 0.26 }, { from: 322000001, to: 385000000, rate: 0.27 }, { from: 385000001, to: 458000000, rate: 0.28 }, { from: 458000001, to: 550000000, rate: 0.29 }, { from: 550000001, to: 675000000, rate: 0.3 }, { from: 675000001, to: 825000000, rate: 0.31 }, { from: 825000001, to: 1025000000, rate: 0.32 }, { from: 1025000001, to: 1325000000, rate: 0.33 }, { from: 1325000001, to: Infinity, rate: 0.34 } ];
        const ter_B = [ { from: 0, to: 6200000, rate: 0 }, { from: 6200001, to: 6500000, rate: 0.0025 }, { from: 6500001, to: 6850000, rate: 0.005 }, { from: 68500001, to: 7300000, rate: 0.0075 }, { from: 7300001, to: 7800000, rate: 0.01 }, { from: 7800001, to: 8850000, rate: 0.0125 }, { from: 8850001, to: 10200000, rate: 0.015 }, { from: 10200001, to: 11250000, rate: 0.0175 }, { from: 11250001, to: 12750000, rate: 0.02 }, { from: 12750001, to: 14100000, rate: 0.0225 }, { from: 14100001, to: 15350000, rate: 0.025 }, { from: 15350001, to: 16600000, rate: 0.03 }, { from: 16600001, to: 18050000, rate: 0.04 }, { from: 18050001, to: 19800000, rate: 0.05 }, { from: 19800001, to: 21850000, rate: 0.06 }, { from: 21850001, to: 24250000, rate: 0.07 }, { from: 24250001, to: 27150000, rate: 0.08 }, { from: 27150001, to: 30550000, rate: 0.09 }, { from: 30550001, to: 34450000, rate: 0.1 }, { from: 34450001, to: 38850000, rate: 0.11 }, { from: 38850001, to: 43850000, rate: 0.12 }, { from: 43850001, to: 49450000, rate: 0.13 }, { from: 49450001, to: 56050000, rate: 0.14 }, { from: 56050001, to: 65250000, rate: 0.15 }, { from: 65250001, to: 76250000, rate: 0.16 }, { from: 76250001, to: 89250000, rate: 0.17 }, { from: 89250001, to: 104250000, rate: 0.18 }, { from: 104250001, to: 121250000, rate: 0.19 }, { from: 121250001, to: 141250000, rate: 0.2 }, { from: 141250001, to: 165250000, rate: 0.21 }, { from: 165250001, to: 196250000, rate: 0.22 }, { from: 196250001, to: 232250000, rate: 0.23 }, { from: 232250001, to: 273250000, rate: 0.24 }, { from: 273250001, to: 326250000, rate: 0.25 }, { from: 326250001, to: 390250000, rate: 0.26 }, { from: 390250001, to: 465250000, rate: 0.27 }, { from: 465250001, to: 560250000, rate: 0.28 }, { from: 560250001, to: 685250000, rate: 0.29 }, { from: 685250001, to: 835250000, rate: 0.3 }, { from: 835250001, to: 1045250000, rate: 0.31 }, { from: 1045250001, to: 1345250000, rate: 0.32 }, { from: 1345250001, to: Infinity, rate: 0.33 } ];
        const ter_C = [ { from: 0, to: 6600000, rate: 0 }, { from: 6600001, to: 6900000, rate: 0.0025 }, { from: 6900001, to: 7250000, rate: 0.005 }, { from: 7250001, to: 7700000, rate: 0.0075 }, { from: 7700001, to: 8950000, rate: 0.01 }, { from: 8950001, to: 10750000, rate: 0.0125 }, { from: 10750001, to: 11800000, rate: 0.015 }, { from: 11800001, to: 12950000, rate: 0.0175 }, { from: 12950001, to: 14250000, rate: 0.02 }, { from: 14250001, to: 15650000, rate: 0.0225 }, { from: 15650001, to: 16950000, rate: 0.025 }, { from: 16950001, to: 18450000, rate: 0.03 }, { from: 18450001, to: 20250000, rate: 0.04 }, { from: 20250001, to: 22150000, rate: 0.05 }, { from: 22150001, to: 24750000, rate: 0.06 }, { from: 24750001, to: 27650000, rate: 0.07 }, { from: 27650001, to: 31050000, rate: 0.08 }, { from: 31050001, to: 34950000, rate: 0.09 }, { from: 34950001, to: 39450000, rate: 0.1 }, { from: 39450001, to: 44450000, rate: 0.11 }, { from: 44450001, to: 50050000, rate: 0.12 }, { from: 50050001, to: 56650000, rate: 0.13 }, { from: 56650001, to: 65850000, rate: 0.14 }, { from: 65850001, to: 77050000, rate: 0.15 }, { from: 77050001, to: 89050000, rate: 0.16 }, { from: 89050001, to: 105050000, rate: 0.17 }, { from: 105050001, to: 122050000, rate: 0.18 }, { from: 122050001, to: 142050000, rate: 0.19 }, { from: 142050001, to: 167050000, rate: 0.2 }, { from: 167050001, to: 198050000, rate: 0.21 }, { from: 198050001, to: 235050000, rate: 0.22 }, { from: 235050001, to: 277050000, rate: 0.23 }, { from: 277050001, to: 331050000, rate: 0.24 }, { from: 331050001, to: 396050000, rate: 0.25 }, { from: 396050001, to: 472050000, rate: 0.26 }, { from: 472050001, to: 568050000, rate: 0.27 }, { from: 568050001, to: 695050000, rate: 0.28 }, { from: 695050001, to: 845050000, rate: 0.29 }, { from: 845050001, to: 1055050000, rate: 0.3 }, { from: 1055050001, to: 1355050000, rate: 0.31 }, { from: 1355050001, to: Infinity, rate: 0.32 } ];
        const ter_Harian = [ { from: 0, to: 450000, rate: 0 }, { from: 450001, to: 2500000, rate: 0.005 }, { from: 2500001, to: Infinity, rate: 0.025 } ];
        const ptkpOptions = [ { value: 'TK0', text: 'TK/0 - Tidak Kawin, 0 Tanggungan' }, { value: 'TK1', text: 'TK/1 - Tidak Kawin, 1 Tanggungan' }, { value: 'TK2', text: 'TK/2 - Tidak Kawin, 2 Tanggungan' }, { value: 'TK3', text: 'TK/3 - Tidak Kawin, 3 Tanggungan' }, { value: 'K0', text: 'K/0 - Kawin, 0 Tanggungan' }, { value: 'K1', text: 'K/1 - Kawin, 1 Tanggungan' }, { value: 'K2', text: 'K/2 - Kawin, 2 Tanggungan' }, { value: 'K3', text: 'K/3 - Kawin, 3 Tanggungan' }, { value: 'KI0', text: 'K/I/0 - Kawin (Istri Bekerja), 0 Tanggungan' }, { value: 'KI1', text: 'K/I/1 - Kawin (Istri Bekerja), 1 Tanggungan' }, { value: 'KI2', text: 'K/I/2 - Kawin (Istri Bekerja), 2 Tanggungan' }, { value: 'KI3', text: 'K/I/3 - Kawin (Istri Bekerja), 3 Tanggungan' } ];

        // --- PPh 21 LOGIC ---
        let lastPph21ImportResults = [];
        function setupPph21() {
            const pph21Content = document.getElementById('pph21-content');
            const ptkpSelectBulanan = pph21Content.querySelector('#ptkp-status-bulanan');
            if(ptkpSelectBulanan) ptkpOptions.forEach(opt => { ptkpSelectBulanan.add(new Option(opt.text, opt.value)); });
            
            pph21Content.querySelectorAll('.pph21-sub-tab-btn').forEach(tab => {
                tab.addEventListener('click', () => {
                    pph21Content.querySelectorAll('.pph21-sub-tab-btn').forEach(t => t.classList.remove('active', 'bg-white', 'text-indigo-700'));
                    tab.classList.add('active', 'bg-white', 'text-indigo-700');
                    pph21Content.querySelectorAll('.pph21-sub-tab-content').forEach(content => { content.classList.toggle('hidden', content.id !== `pph21-${tab.dataset.subtab}-content`); });
                });
            });

            // Bulanan
            pph21Content.querySelectorAll('.p21-income').forEach(input => input.addEventListener('input', updateBrutoBulanan));
            pph21Content.querySelectorAll('input[name="tax-method"]').forEach(radio => radio.addEventListener('change', updateBrutoBulanan));
            pph21Content.querySelector('#calculateBtn-pph21-bulanan').addEventListener('click', calculatePph21Bulanan);
            pph21Content.querySelector('#resetBtn-pph21-bulanan').addEventListener('click', resetFormBulanan);
            pph21Content.querySelector('#template-excel-btn-pph21').addEventListener('click', downloadPph21Template);
            pph21Content.querySelector('#import-excel-pph21').addEventListener('change', handlePph21Import);

            // Tahunan
            pph21Content.querySelectorAll('#status-pegawai-tahunan, #status-kawin-tahunan').forEach(select => select.addEventListener('change', updateTahunanTotals));
            pph21Content.querySelectorAll('.p21-income-tahunan, .p21-pengurang-tahunan, #tanggungan-tahunan').forEach(input => input.addEventListener('input', updateTahunanTotals));
            pph21Content.querySelector('#calculateBtn-pph21-tahunan').addEventListener('click', calculatePph21AkhirTahun);
            pph21Content.querySelector('#resetBtn-pph21-tahunan').addEventListener('click', resetFormTahunan);
            updateTahunanTotals(); // Initial call to set calculated fields
        }

        function calculateTer(bruto, ptkpStatus) {
            bruto = Math.round(bruto);
            const category = ptkpRates[ptkpStatus]?.category || 'A';
            const terTable = category === 'A' ? ter_A : (category === 'B' ? ter_B : ter_C);
            const foundRate = terTable.find(range => bruto >= range.from && bruto <= range.to);
            const terRate = foundRate ? foundRate.rate : 0;
            const pph21 = Math.round(bruto * terRate);
            return { pph21, terRate, category, bruto };
        }

        function calculateGrossUp(baseIncome, ptkpStatus) {
            let tunjanganPph = 0;
            let pphFinal = 0;
            for (let i = 0; i < 10; i++) { // Max 10 iterations to prevent infinite loops
                const bruto = Math.round(baseIncome + tunjanganPph);
                const { pph21 } = calculateTer(bruto, ptkpStatus);
                const newTunjangan = pph21;
                if (Math.abs(newTunjangan - tunjanganPph) < 1) { // Converged
                    pphFinal = pph21;
                    break;
                }
                tunjanganPph = newTunjangan;
                pphFinal = pph21;
            }
            return { tunjanganPph: Math.round(tunjanganPph), pphFinal: Math.round(pphFinal) };
        }
        
        function updateBrutoBulanan() {
            const isGrossUp = document.querySelector('input[name="tax-method"]:checked').value === 'gross-up';
            const tunjanganPphInput = document.getElementById('tunjangan-pph');
            tunjanganPphInput.disabled = isGrossUp;
            if (isGrossUp) {
                tunjanganPphInput.classList.add('bg-gray-100');
                tunjanganPphInput.value = '';
            } else {
                tunjanganPphInput.classList.remove('bg-gray-100');
            }
            let bruto = 0;
            document.querySelectorAll('.p21-income').forEach(input => { if(input.id !== 'penghasilan-bruto-bulanan') bruto += parseFloat(input.value) || 0; });
            document.getElementById('penghasilan-bruto-bulanan').value = Math.round(bruto);
        }

        function resetFormBulanan() {
            document.querySelectorAll('#pph21-bulanan-content .form-input, #pph21-bulanan-content .form-select').forEach(el => {
                if (el.tagName === 'SELECT') el.selectedIndex = 0; else if (el.type !== 'radio' && el.type !== 'checkbox') el.value = '';
            });
            document.querySelector('input[name="tax-method"][value="gross"]').checked = true;
            updateBrutoBulanan();
            document.getElementById('result-pph21-bulanan').innerHTML = `<h4 class="text-lg font-semibold border-b pb-2 mb-4">B. Penghitungan PPh Pasal 21</h4><div class="text-center text-gray-500">Hasil perhitungan akan muncul di sini.</div>`;
        }
        
        function calculatePph21Bulanan() {
            let baseBruto = 0;
            document.querySelectorAll('.p21-income').forEach(input => { if(input.id !== 'penghasilan-bruto-bulanan' && input.id !== 'tunjangan-pph') baseBruto += parseFloat(input.value) || 0; });
            
            const ptkpStatus = document.getElementById('ptkp-status-bulanan').value;
            const resultDiv = document.getElementById('result-pph21-bulanan');
            const isGrossUp = document.querySelector('input[name="tax-method"]:checked').value === 'gross-up';

            let finalBruto, pph21, terRate, category, tunjanganPph = 0;

            if (isGrossUp) {
                const grossUpResult = calculateGrossUp(baseIncome, ptkpStatus);
                tunjanganPph = grossUpResult.tunjanganPph;
                pph21 = grossUpResult.pphFinal;
                finalBruto = Math.round(baseBruto + tunjanganPph);
                const terResult = calculateTer(finalBruto, ptkpStatus);
                terRate = terResult.terRate;
                category = terResult.category;
                document.getElementById('tunjangan-pph').value = tunjanganPph;
                document.getElementById('penghasilan-bruto-bulanan').value = finalBruto;
            } else {
                tunjanganPph = parseFloat(document.getElementById('tunjangan-pph').value) || 0;
                finalBruto = Math.round(baseBruto + tunjanganPph);
                if (finalBruto <= 0) {
                    resultDiv.innerHTML = `<h4 class="text-lg font-semibold border-b pb-2 mb-4">B. Penghitungan PPh Pasal 21</h4><p class="text-red-500 font-semibold">Penghasilan bruto harus lebih besar dari 0.</p>`; return;
                }
                const terResult = calculateTer(finalBruto, ptkpStatus);
                pph21 = terResult.pph21;
                terRate = terResult.terRate;
                category = terResult.category;
            }

            resultDiv.innerHTML = `<h4 class="font-bold text-lg mb-3">Hasil Perhitungan</h4><div class="space-y-3 text-sm"><div class="result-item"><span>Penghasilan Bruto</span> <span class="font-semibold">Rp ${formatNumber(finalBruto)}</span></div><div class="result-item"><span>Status PTKP / Kategori</span> <span class="font-semibold">${ptkpStatus} / ${category}</span></div><div class="result-item"><span>Tarif Efektif (TER)</span> <span class="font-semibold">${(terRate * 100).toFixed(4)}%</span></div></div><div class="mt-4 pt-4 border-t-2 border-dashed"><div class="flex justify-between items-center"><span class="text-base font-semibold">PPh 21 Terutang Bulan Ini</span><span class="text-xl font-bold text-indigo-600">Rp ${formatNumber(pph21)}</span></div></div>`;
        }

        function downloadPph21Template() {
            const mainHeaders = [['NIK', 'Nama Pegawai', 'Status PTKP (e.g., K0, TK2)', 'Metode (GROSS / GROSSUP)', 'Gaji/Pensiun', 'Tunjangan PPh (jika GROSS)', 'Tunjangan Lain', 'Honorarium', 'Premi Asuransi', 'Natura', 'Bonus/THR']];
            const refHeaders = [['Kode PTKP', 'Keterangan'], ...ptkpOptions.map(o => [o.value, o.text])];
            
            const wsMain = XLSX.utils.aoa_to_sheet(mainHeaders);
            wsMain['!cols'] = [{wch: 18}, {wch: 25}, {wch: 25}, {wch: 25}, {wch: 15}, {wch: 25}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}];
            
            const wsRef = XLSX.utils.aoa_to_sheet(refHeaders);
            wsRef['!cols'] = [{wch: 15}, {wch: 40}];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, wsMain, "Template Impor");
            XLSX.utils.book_append_sheet(wb, wsRef, "Referensi PTKP");
            XLSX.writeFile(wb, "Template_Impor_PPh_21_Bulanan.xlsx");
        }
        
        function handlePph21Import(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                processPph21Import(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function processPph21Import(data) {
            lastPph21ImportResults = data.map(row => {
                const ptkpStatus = row['Status PTKP (e.g., K0, TK2)']?.trim().toUpperCase() || 'TK0';
                const baseIncome = (parseFloat(row['Gaji/Pensiun']) || 0) + (parseFloat(row['Tunjangan Lain']) || 0) + (parseFloat(row['Honorarium']) || 0) + (parseFloat(row['Premi Asuransi']) || 0) + (parseFloat(row['Natura']) || 0) + (parseFloat(row['Bonus/THR']) || 0);
                const method = row['Metode (GROSS / GROSSUP)']?.trim().toUpperCase() === 'GROSSUP' ? 'gross-up' : 'gross';

                let finalBruto, pph21, tunjanganPph = 0;

                if(method === 'gross-up') {
                    const grossUpResult = calculateGrossUp(baseIncome, ptkpStatus);
                    tunjanganPph = grossUpResult.tunjanganPph;
                    pph21 = grossUpResult.pphFinal;
                    finalBruto = Math.round(baseIncome + tunjanganPph);
                } else {
                    tunjanganPph = parseFloat(row['Tunjangan PPh (jika GROSS)']) || 0;
                    finalBruto = Math.round(baseIncome + tunjanganPph);
                    const terResult = calculateTer(finalBruto, ptkpStatus);
                    pph21 = terResult.pph21;
                }
                
                return { NIK: row['NIK'], 'Nama Pegawai': row['Nama Pegawai'], 'Status PTKP': ptkpStatus, 'Metode': method.toUpperCase(), 'Tunjangan PPh': tunjanganPph, 'Penghasilan Bruto': finalBruto, 'PPh 21 Terutang': pph21 };
            });
            displayPph21ImportResults(lastPph21ImportResults);
        }

        function displayPph21ImportResults(results) {
            const resultContainer = document.getElementById('import-result-pph21');
            const tableContainer = resultContainer.querySelector('.table-responsive > table');
            tableContainer.innerHTML = `
                <thead class="bg-gray-100"><tr>
                    <th class="p-2 border">NIK</th><th class="p-2 border">Nama</th><th class="p-2 border">Status</th><th class="p-2 border">Metode</th><th class="p-2 border">Tj. PPh</th><th class="p-2 border">Bruto</th><th class="p-2 border">PPh 21</th>
                </tr></thead>
                <tbody>${results.map(res => `<tr>
                    <td class="p-2 border">${res['NIK']}</td><td class="p-2 border">${res['Nama Pegawai']}</td><td class="p-2 border">${res['Status PTKP']}</td><td class="p-2 border">${res['Metode']}</td><td class="p-2 border text-right">${formatNumber(res['Tunjangan PPh'])}</td><td class="p-2 border text-right">${formatNumber(res['Penghasilan Bruto'])}</td><td class="p-2 border text-right">${formatNumber(res['PPh 21 Terutang'])}</td>
                </tr>`).join('')}</tbody>`;
            resultContainer.classList.remove('hidden');
            document.getElementById('export-excel-btn-pph21').onclick = () => exportPph21ResultsToExcel();
        }
        
        function exportPph21ResultsToExcel(){
             const ws = XLSX.utils.json_to_sheet(lastPph21ImportResults);
             ws['!cols'] = [{wch: 18}, {wch: 25}, {wch: 15}, {wch: 15}, {wch: 18}, {wch: 18}, {wch:15}];
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "Hasil Impor PPh 21");
             XLSX.writeFile(wb, "Hasil_Impor_PPh_21_Bulanan.xlsx");
        }
        
        function getPtkpTahunan() {
            const statusKawin = document.getElementById('status-kawin-tahunan').value; // TK, K, KI
            const tanggunganEl = document.getElementById('tanggungan-tahunan');
            const tanggungan = parseInt(tanggunganEl.value) || 0;

            if (tanggungan < 0 || tanggungan > 3) {
                showError('error-container-pph21-tahunan', 'Jumlah tanggungan harus antara 0 dan 3.');
                tanggunganEl.value = 0; // Reset to valid value
                return null;
            }

            const ptkpMatrix = {
                'TK': [54000000, 58500000, 63000000, 67500000],
                'K':  [58500000, 63000000, 67500000, 72000000],
                'KI': [112500000, 117000000, 121500000, 126000000]
            };

            return ptkpMatrix[statusKawin][tanggungan];
        }

        function updateTahunanTotals() {
            let bruto = 0;
            document.querySelectorAll('.p21-income-tahunan').forEach(input => {
                bruto += parseFloat(input.value) || 0;
            });
            document.getElementById('total-bruto-tahunan').value = `Rp ${formatNumber(bruto)}`;

            const statusPegawai = document.getElementById('status-pegawai-tahunan').value;
            const maxBiayaJabatan = statusPegawai === 'tetap' ? 6000000 : 2400000;
            const biayaJabatan = Math.min(bruto * 0.05, maxBiayaJabatan);
            document.getElementById('biaya-jabatan-pensiun-tahunan').value = `Rp ${formatNumber(biayaJabatan)}`;

            const iuranPensiun = parseFloat(document.getElementById('iuran-pensiun-tahunan').value) || 0;
            const zakat = parseFloat(document.getElementById('zakat-tahunan').value) || 0;
            const totalPengurang = biayaJabatan + iuranPensiun + zakat;
            document.getElementById('total-pengurang-tahunan').value = `Rp ${formatNumber(totalPengurang)}`;
        }

        function resetFormTahunan() {
            document.querySelectorAll('#pph21-akhirtahun-content .form-input, #pph21-akhirtahun-content .form-select').forEach(el => {
                if (el.tagName === 'SELECT') {
                    el.selectedIndex = 0;
                } else if (el.type !== 'button' && !el.disabled) {
                    el.value = el.id === 'tanggungan-tahunan' ? '0' : '';
                }
            });
            updateTahunanTotals(); // To reset calculated fields
            document.getElementById('result-pph21-akhirtahun').innerHTML = `<h4 class="text-lg font-semibold border-b pb-2 mb-4">E. Hasil Perhitungan</h4><div class="text-center text-gray-500">Hasil perhitungan akan muncul di sini.</div>`;
            clearError('error-container-pph21-tahunan');
        }

        function calculatePph21AkhirTahun() {
            clearError('error-container-pph21-tahunan');
            // Recalculate values to ensure they are numeric
            let brutoSetahun = 0;
            document.querySelectorAll('.p21-income-tahunan').forEach(input => {
                brutoSetahun += parseFloat(input.value) || 0;
            });

            const statusPegawai = document.getElementById('status-pegawai-tahunan').value;
            const maxBiayaJabatan = statusPegawai === 'tetap' ? 6000000 : 2400000;
            const biayaJabatan = Math.min(brutoSetahun * 0.05, maxBiayaJabatan);
            const iuranPensiun = parseFloat(document.getElementById('iuran-pensiun-tahunan').value) || 0;
            const zakat = parseFloat(document.getElementById('zakat-tahunan').value) || 0;
            const totalPengurang = biayaJabatan + iuranPensiun + zakat;

            const pph21Dipotong = parseFloat(document.getElementById('pph21-dipotong-sebelumnya').value) || 0;
            const resultDiv = document.getElementById('result-pph21-akhirtahun');
            
            const ptkpTahunan = getPtkpTahunan();
            if (ptkpTahunan === null) return; // Error already shown by getPtkpTahunan

            const nettoSetahun = brutoSetahun - totalPengurang;
            const pkpSetahun = Math.max(0, Math.floor((nettoSetahun - ptkpTahunan) / 1000) * 1000);

            let pphTerutang = 0;
            let sisaPkp = pkpSetahun;
            let detailPerhitungan = '';
            const tarifLayers = [
                { limit: 60000000, rate: 0.05 },
                { limit: 250000000, rate: 0.15 },
                { limit: 500000000, rate: 0.25 },
                { limit: 5000000000, rate: 0.30 },
                { limit: Infinity, rate: 0.35 }
            ];
            let batasBawah = 0;
            
            for (const layer of tarifLayers) {
                if (sisaPkp <= 0) break;
                const pkpDiLayer = Math.min(sisaPkp, layer.limit - batasBawah);
                const pajakDiLayer = pkpDiLayer * layer.rate;
                pphTerutang += pajakDiLayer;
                if (pajakDiLayer > 0) {
                    detailPerhitungan += `<li class="flex justify-between"><span>${(layer.rate * 100)}% &times; Rp ${formatNumber(pkpDiLayer)}</span> <span>= Rp ${formatNumber(pajakDiLayer)}</span></li>`;
                }
                sisaPkp -= pkpDiLayer;
                batasBawah = layer.limit;
            }

            const pph21MasaTerakhir = pphTerutang - pph21Dipotong;
            const statusPotong = pph21MasaTerakhir >= 0 ? "Kurang Bayar" : "Lebih Bayar";

            resultDiv.innerHTML = `
                <h4 class="font-bold text-lg mb-3 border-b pb-2">E. Hasil Perhitungan</h4>
                <div class="space-y-2 text-sm">
                    <!-- Step 1: Bruto to Neto -->
                    <div class="font-semibold text-gray-700">1. Penghasilan Neto Setahun</div>
                    <div class="pl-4 space-y-1 text-xs">
                        <div class="flex justify-between"><span>Penghasilan Bruto Setahun</span> <span>Rp ${formatNumber(brutoSetahun)}</span></div>
                        <div class="flex justify-between"><span>Total Pengurang</span> <span>- Rp ${formatNumber(totalPengurang)}</span></div>
                        <div class="flex justify-between font-bold border-t pt-1 mt-1 text-sm"><span>Penghasilan Neto Setahun</span> <span>Rp ${formatNumber(nettoSetahun)}</span></div>
                    </div>

                    <!-- Step 2: Neto to PKP -->
                    <div class="font-semibold text-gray-700 pt-3">2. Penghasilan Kena Pajak (PKP)</div>
                    <div class="pl-4 space-y-1 text-xs">
                        <div class="flex justify-between"><span>Penghasilan Neto Setahun</span> <span>Rp ${formatNumber(nettoSetahun)}</span></div>
                        <div class="flex justify-between"><span>PTKP</span> <span>- Rp ${formatNumber(ptkpTahunan)}</span></div>
                        <div class="flex justify-between font-bold border-t pt-1 mt-1 text-sm"><span>PKP Setahun (Dibulatkan)</span> <span>Rp ${formatNumber(pkpSetahun)}</span></div>
                    </div>

                    <!-- Step 3: PPh Terutang -->
                    <div class="font-semibold text-gray-700 pt-3">3. PPh 21 Terutang Setahun (Tarif Psl. 17)</div>
                    <div class="pl-4">
                        <ul class="space-y-1 text-xs">${detailPerhitungan || '<li>Tidak ada PPh terutang.</li>'}</ul>
                        <div class="flex justify-between font-bold border-t pt-1 mt-1 text-sm"><span>Total PPh Terutang Setahun</span> <span>Rp ${formatNumber(pphTerutang)}</span></div>
                    </div>

                    <!-- Step 4: PPh Masa Terakhir -->
                    <div class="font-semibold text-gray-700 pt-3">4. PPh 21 Masa Pajak Terakhir</div>
                    <div class="pl-4 space-y-1 text-xs">
                        <div class="flex justify-between"><span>PPh Terutang Setahun</span> <span>Rp ${formatNumber(pphTerutang)}</span></div>
                        <div class="flex justify-between"><span>Telah Dipotong (Jan-Nov)</span> <span>- Rp ${formatNumber(pph21Dipotong)}</span></div>
                    </div>
                </div>

                <!-- Final Result -->
                <div class="mt-4 pt-4 border-t-2 border-indigo-500">
                    <div class="flex justify-between items-center">
                        <span class="text-base font-semibold">PPh 21 Masa Pajak Terakhir</span>
                        <span class="text-xl font-bold text-indigo-600">Rp ${formatNumber(Math.abs(pph21MasaTerakhir))}</span>
                    </div>
                    <p class="text-sm text-center font-semibold mt-2 text-gray-700">(${statusPotong})</p>
                </div>
                <div class="mt-4 text-xs p-2 bg-gray-100 rounded">
                    <b>Catatan:</b> Jika Lebih Bayar, pemberi kerja wajib mengembalikan kelebihan potong kepada pegawai. PPh 21 terutang setahun ini menjadi kredit pajak di SPT Tahunan OP.
                </div>
            `;
        }

        function setupUnifikasi() {
            const unifikasiContent = document.getElementById('unifikasi-content');
            let unifikasiTransactionCounter = 0;
            let lastUnifikasiResults = [];
            const rowsContainer = unifikasiContent.querySelector('#transaction-rows-container-unifikasi');
            
            const taxTypesUnifikasi = {
                '28-403-01': { category: 'PPh Pasal 4 ayat (2)', desc: 'Bunga Deposito/Tabungan/Diskonto SBI - Pihak dalam negeri dan BUT', rate: 20 },
                '28-403-02': { category: 'PPh Pasal 4 ayat (2)', desc: 'Bunga Deposito/Tabungan/Diskonto SBI - Pihak luar negeri', rate: 20 },
                '28-404-01': { category: 'PPh Pasal 4 ayat (2)', desc: 'Bunga Obligasi (termasuk SUN) < 5 tahun', rate: 5 },
                '28-404-02': { category: 'PPh Pasal 4 ayat (2)', desc: 'Bunga Obligasi (termasuk SUN) > 5 tahun', rate: 10 },
                '28-405-01': { category: 'PPh Pasal 4 ayat (2)', desc: 'Persewaan Tanah dan/atau Bangunan', rate: 10 },
                '28-409-01': { category: 'PPh Pasal 4 ayat (2)', desc: 'Jasa Konstruksi - Pelaksana (Kecil)', rate: 1.75 },
                '28-409-02': { category: 'PPh Pasal 4 ayat (2)', desc: 'Jasa Konstruksi - Pelaksana (Menengah/Besar)', rate: 2.65 },
                '28-409-05': { category: 'PPh Pasal 4 ayat (2)', desc: 'Jasa Konstruksi - Konsultan', rate: 3.5 },
                '28-419-01': { category: 'PPh Pasal 4 ayat (2)', desc: 'Dividen yang diterima Orang Pribadi', rate: 10 },
                '28-499-01': { category: 'PPh Pasal 4 ayat (2)', desc: 'Transaksi Derivatif (Bursa)', rate: 2.5 },
                '27-102-01': { category: 'PPh Pasal 15', desc: 'Pelayaran Dalam Negeri', rate: 1.2 },
                '27-102-02': { category: 'PPh Pasal 15', desc: 'Penerbangan Dalam Negeri', rate: 1.8 },
                '27-102-03': { category: 'PPh Pasal 15', desc: 'Pelayaran/Penerbangan Luar Negeri', rate: 2.64 },
                '22-101-01': { category: 'PPh Pasal 22', desc: 'Impor dengan API', rate: 2.5 },
                '22-101-02': { category: 'PPh Pasal 22', desc: 'Impor tanpa API', rate: 7.5 },
                '22-401-01': { category: 'PPh Pasal 22', desc: 'Pembelian oleh Bendaharawan/BUMN/BUMD', rate: 1.5 },
                '22-403-01': { category: 'PPh Pasal 22', desc: 'Penjualan Hasil Produksi Semen', rate: 0.25 },
                '22-403-02': { category: 'PPh Pasal 22', desc: 'Penjualan Hasil Produksi Kertas', rate: 0.1 },
                '22-403-03': { category: 'PPh Pasal 22', desc: 'Penjualan Hasil Produksi Baja', rate: 0.3 },
                '22-403-04': { category: 'PPh Pasal 22', desc: 'Penjualan Hasil Produksi Otomotif', rate: 0.45 },
                '24-100-01': { category: 'PPh Pasal 23', desc: 'Dividen (selain yang diterima OP atau dikecualikan)', rate: 15 },
                '24-101-01': { category: 'PPh Pasal 23', desc: 'Bunga (termasuk premium, diskonto, imbalan jaminan)', rate: 15 },
                '24-102-01': { category: 'PPh Pasal 23', desc: 'Royalti', rate: 15 },
                '24-103-01': { category: 'PPh Pasal 23', desc: 'Hadiah, Penghargaan, Bonus (selain yang dipotong PPh 21)', rate: 15 },
                '24-104-01': { category: 'PPh Pasal 23', desc: 'Sewa dan Penghasilan Lain Sehubungan Penggunaan Harta (selain tanah/bangunan)', rate: 2 },
                '24-104-02': { category: 'PPh Pasal 23', desc: 'Jasa Teknik', rate: 2 },
                '24-104-03': { category: 'PPh Pasal 23', desc: 'Jasa Manajemen', rate: 2 },
                '24-104-04': { category: 'PPh Pasal 23', desc: 'Jasa Konsultan (selain konsultan konstruksi)', rate: 2 },
                '24-104-25': { category: 'PPh Pasal 23', desc: 'Jasa Penilai (Appraisal)', rate: 2 },
                '24-104-26': { category: 'PPh Pasal 23', desc: 'Jasa Aktuaris', rate: 2 },
                '29-100-01': { category: 'PPh Pasal 26', desc: 'Dividen', rate: 20 },
                '29-101-01': { category: 'PPh Pasal 26', desc: 'Bunga', rate: 20 },
                '29-102-01': { category: 'PPh Pasal 26', desc: 'Royalti, Sewa, dan Penghasilan Lain', rate: 20 },
                '29-104-01': { category: 'PPh Pasal 26', desc: 'Imbalan Jasa, Pekerjaan, dan Kegiatan', rate: 20 },
            };

            const groupedTaxes = {};
            for (const code in taxTypesUnifikasi) {
                const tax = taxTypesUnifikasi[code];
                if (!groupedTaxes[tax.category]) {
                    groupedTaxes[tax.category] = [];
                }
                groupedTaxes[tax.category].push({ code, ...tax });
            }

            let taxOptionsHtml = '<option value="">-- Pilih Jenis Pajak --</option>';
            for (const category in groupedTaxes) {
                taxOptionsHtml += `<optgroup label="${category}">`;
                groupedTaxes[category].forEach(tax => {
                    taxOptionsHtml += `<option value="${tax.code}">${tax.code} - ${tax.desc}</option>`;
                });
                taxOptionsHtml += `</optgroup>`;
            }

            function addUnifikasiRow() {
                const id = unifikasiTransactionCounter++;
                const newRow = document.createElement('tr');
                newRow.className = 'transaction-row-unifikasi';
                newRow.id = `row-unifikasi-${id}`;
                newRow.innerHTML = `<td class="text-center text-sm text-gray-500">${id + 1}</td><td><input type="text" class="form-input invoice-no" placeholder="Opsional"></td><td><input type="text" class="form-input company-name" placeholder="Nama Perusahaan"></td><td><select class="form-select pph-type">${taxOptionsHtml}</select></td><td><input type="number" class="form-input pph-rate" step="0.01" placeholder="0"></td><td><input type="number" class="form-input dpp" placeholder="100000"></td><td><div class="flex items-center gap-2"><select class="form-select ppn-option"><option value="none">Tanpa PPN</option><option value="11">PPN 11%</option><option value="1.1">PPN 1.1%</option><option value="custom">PPN Custom</option></select><input type="number" class="form-input ppn-custom-rate hidden" placeholder="Tarif %"></div></td><td class="text-center"><button class="delete-btn" title="Hapus Baris"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></td>`;
                rowsContainer.appendChild(newRow);
                newRow.querySelector('.pph-type').addEventListener('change', () => updateUnifikasiPphRate(newRow));
                newRow.querySelector('.ppn-option').addEventListener('change', () => handleUnifikasiPpnOptionChange(newRow));
                newRow.querySelector('.delete-btn').addEventListener('click', () => deleteUnifikasiRow(newRow));
                updateUnifikasiPphRate(newRow);
            }

            function updateUnifikasiPphRate(row) {
                const selectedCode = row.querySelector('.pph-type').value;
                const taxInfo = taxTypesUnifikasi[selectedCode];
                row.querySelector('.pph-rate').value = taxInfo ? taxInfo.rate : 0;
            }

            function handleUnifikasiPpnOptionChange(row) { row.querySelector('.ppn-custom-rate').classList.toggle('hidden', row.querySelector('.ppn-option').value !== 'custom'); }
            function deleteUnifikasiRow(row) { row.remove(); document.querySelectorAll('.transaction-row-unifikasi').forEach((r, i) => { r.cells[0].textContent = i + 1; }); }
            
            unifikasiContent.querySelector('#add-row-btn-unifikasi').addEventListener('click', addUnifikasiRow);
            unifikasiContent.querySelector('#calculateBtn-unifikasi').addEventListener('click', calculateAllUnifikasi);
            unifikasiContent.querySelector('#export-excel-btn-unifikasi').addEventListener('click', exportUnifikasiToExcel);
            unifikasiContent.querySelector('#export-pdf-btn-unifikasi').addEventListener('click', exportUnifikasiToPDF);

            function calculateAllUnifikasi() {
                clearError('error-container-unifikasi');
                const rows = document.querySelectorAll('.transaction-row-unifikasi');
                if (rows.length === 0) { showError('error-container-unifikasi', "Silakan tambah baris transaksi terlebih dahulu."); return; }
                let allResults = []; let hasError = false;
                rows.forEach((row, index) => {
                    if (hasError) return;
                    try {
                        const invoiceNo = row.querySelector('.invoice-no').value.trim();
                        const companyName = row.querySelector('.company-name').value.trim();
                        const dpp = parseFloat(row.querySelector('.dpp').value);
                        if (isNaN(dpp) || dpp <= 0) throw new Error(`DPP pada baris #${index + 1} tidak valid.`);
                        const pphTypeSelect = row.querySelector('.pph-type');
                        const selectedTaxKey = pphTypeSelect.value;
                        if (!selectedTaxKey) throw new Error(`Jenis Pajak pada baris #${index + 1} belum dipilih.`);
                        
                        const pphRate = parseFloat(row.querySelector('.pph-rate').value) / 100;
                        if (isNaN(pphRate) || pphRate < 0) throw new Error(`Tarif PPh pada baris #${index + 1} tidak valid.`);
                        const pph = dpp * pphRate;
                        const pphDesc = pphTypeSelect.options[pphTypeSelect.selectedIndex].text;
                        
                        const ppnSelect = row.querySelector('.ppn-option');
                        let ppn = 0; let ppnDesc = '';
                        if (ppnSelect.value !== 'none') {
                            let ppnRate = 0;
                            if (ppnSelect.value === 'custom') {
                                const customPpnRate = parseFloat(row.querySelector('.ppn-custom-rate').value);
                                if (isNaN(customPpnRate) || customPpnRate < 0) throw new Error(`Tarif PPN Custom pada baris #${index + 1} tidak valid.`);
                                ppnRate = customPpnRate / 100;
                                ppnDesc = `PPN ${customPpnRate}%`;
                            } else {
                                ppnRate = parseFloat(ppnSelect.value) / 100;
                                ppnDesc = `PPN ${ppnSelect.value}%`;
                            }
                            ppn = dpp * ppnRate;
                        }
                        const roundedPph = Math.round(pph);
                        const roundedPpn = Math.round(ppn);
                        const finalPayment = (dpp + roundedPpn - roundedPph);
                        let fullDesc = pphDesc;
                        if (ppnSelect.value !== 'none') { fullDesc = fullDesc ? `${fullDesc} + ${ppnDesc}` : ppnDesc; }
                        
                        allResults.push({ invoiceNo, companyName, description: fullDesc, dpp, ppn: roundedPpn, pph: roundedPph, actualPayment: finalPayment });
                    } catch (e) {
                        showError('error-container-unifikasi', e.message);
                        hasError = true;
                    }
                });
                if (!hasError) {
                    lastUnifikasiResults = allResults;
                    displayUnifikasiResults(allResults);
                }
            }

             function displayUnifikasiResults(results) {
                 const resultContainer = document.getElementById('result-container-unifikasi');
                 const resultBody = document.getElementById('result-table-body-unifikasi');
                 const resultFoot = document.getElementById('result-table-foot-unifikasi');
                 resultBody.innerHTML = ''; resultFoot.innerHTML = '';
                 let totalDpp = 0, totalPpn = 0, totalPph = 0, totalActual = 0;
                 results.forEach(res => {
                     totalDpp += res.dpp; totalPpn += res.ppn; totalPph += res.pph; totalActual += res.actualPayment;
                     resultBody.innerHTML += `<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${res.invoiceNo || '-'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${res.companyName || '-'}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${res.description}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(res.dpp)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(res.ppn)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formatNumber(res.pph)}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-right">${formatNumber(res.actualPayment)}</td></tr>`;
                 });
                 if (results.length > 1) {
                     resultFoot.innerHTML = `<tr><td class="px-6 py-4 text-left text-sm font-bold" colspan="3">JUMLAH</td><td class="px-6 py-4 text-right text-sm font-bold">${formatNumber(totalDpp)}</td><td class="px-6 py-4 text-right text-sm font-bold">${formatNumber(totalPpn)}</td><td class="px-6 py-4 text-right text-sm font-bold">${formatNumber(totalPph)}</td><td class="px-6 py-4 text-right text-sm font-bold">${formatNumber(totalActual)}</td></tr>`;
                 }
                 resultContainer.classList.remove('hidden');
             }

            function exportUnifikasiToExcel() {
                if (!lastUnifikasiResults || lastUnifikasiResults.length === 0) {
                    showError('error-container-unifikasi', 'Tidak ada data untuk diekspor. Silakan hitung pajak terlebih dahulu.');
                    return;
                }
                const exportData = lastUnifikasiResults.map(res => ({
                    'No. Invoice': res.invoiceNo || '-',
                    'Nama Perusahaan': res.companyName || '-',
                    'Deskripsi': res.description,
                    'DPP': res.dpp,
                    'PPN': res.ppn,
                    'PPh': res.pph,
                    'Jumlah Tagihan/Pembayaran': res.actualPayment
                }));

                const ws = XLSX.utils.json_to_sheet(exportData);
                ws['!cols'] = [{ wch: 15 }, { wch: 25 }, { wch: 40 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 25 }];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Hasil PPh Unifikasi");
                XLSX.writeFile(wb, "Hasil_Perhitungan_PPh_Unifikasi.xlsx");
            }

            function exportUnifikasiToPDF() {
                if (!lastUnifikasiResults || lastUnifikasiResults.length === 0) {
                    showError('error-container-unifikasi', 'Tidak ada data untuk diekspor. Silakan hitung pajak terlebih dahulu.');
                    return;
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.text("Hasil Perhitungan PPh Unifikasi", 14, 15);

                const tableColumn = ["No. Invoice", "Nama Perusahaan", "Deskripsi", "DPP", "PPN", "PPh", "Jumlah"];
                const tableRows = [];

                lastUnifikasiResults.forEach(res => {
                    const rowData = [
                        res.invoiceNo || '-',
                        res.companyName || '-',
                        res.description,
                        formatNumber(res.dpp),
                        formatNumber(res.ppn),
                        formatNumber(res.pph),
                        formatNumber(res.actualPayment)
                    ];
                    tableRows.push(rowData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 20,
                    theme: 'striped',
                    headStyles: { fillColor: [79, 70, 229] }, // Indigo color
                    styles: { halign: 'right' },
                    columnStyles: {
                        0: { halign: 'left' },
                        1: { halign: 'left' },
                        2: { halign: 'left' }
                    }
                });

                doc.save('Hasil_Perhitungan_PPh_Unifikasi.pdf');
            }
             
             addUnifikasiRow();
        }

        function setupTerTab() {
            const terContent = document.getElementById('ter-content');
            const terTablesContainer = terContent.querySelector('#ter-tables-container');
            
            function createTerTable(data, category) {
                const tableId = `ter-table-${category}`;
                let tableHtml = `<div id="${tableId}" class="ter-sub-tab-content"><div class="table-responsive max-h-96"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Penghasilan Bruto (Dari)</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase">Penghasilan Bruto (Sampai)</th><th class="px-6 py-3 bg-gray-50 text-right text-xs font-medium text-gray-500 uppercase">Tarif Efektif (%)</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                data.forEach(row => {
                    tableHtml += `<tr><td class="px-6 py-4 whitespace-nowrap text-sm">Rp ${formatNumber(row.from)}</td><td class="px-6 py-4 whitespace-nowrap text-sm">Rp ${formatNumber(row.to)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-right">${(row.rate * 100).toFixed(2)}%</td></tr>`;
                });
                tableHtml += `</tbody></table></div></div>`;
                return tableHtml;
            }

            terTablesContainer.innerHTML = createTerTable(ter_A, 'A') + createTerTable(ter_B, 'B') + createTerTable(ter_C, 'C') + createTerTable(ter_Harian, 'Harian');
            
            const terSubTabs = terContent.querySelectorAll('.sub-tab-btn');
            const terSubContents = terContent.querySelectorAll('.ter-sub-tab-content');
            
            terSubContents.forEach((content, index) => {
                if(index !== 0) content.classList.add('hidden');
            });

            terSubTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    terSubTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    terSubContents.forEach(content => {
                        content.classList.toggle('hidden', content.id !== `ter-table-${tab.dataset.tertab}`);
                    });
                });
            });
        }

        function setupDonasiTab() {
            const donasiContent = document.getElementById('donasi-content');
            const donationAmountInput = donasiContent.querySelector('#donation-amount');
            const donationAmountBtns = donasiContent.querySelectorAll('.donation-amount-btn');
            const errorContainer = donasiContent.querySelector('#donation-error-container');
            
            donationAmountBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    donationAmountBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    donationAmountInput.value = btn.dataset.amount;
                });
            });

            donationAmountInput.addEventListener('input', () => {
                donationAmountBtns.forEach(b => b.classList.remove('selected'));
            });

            donasiContent.querySelector('#donate-btn').addEventListener('click', () => {
                errorContainer.innerHTML = ''; // Clear previous errors
                const amount = document.getElementById('donation-amount').value;
                const message = document.getElementById('donation-message').value;
                const name = document.getElementById('donation-name').value;
                
                if(!amount || amount < 1000) {
                    errorContainer.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">Masukkan nominal donasi minimal Rp 1.000</div>`;
                    return;
                }

                let finalMessage = message;
                if (name) {
                    finalMessage = `${name}: ${message}`;
                }

                const saweriaUrl = `https://saweria.co/jevissal?amount=${amount}&msg=${encodeURIComponent(finalMessage)}`;
                window.open(saweriaUrl, '_blank');
            });
        }

        // --- MAIN APP INITIALIZATION ---
        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === `${tab.dataset.tab}-content`);
                });
            });
        });
        
        setupPph21();
        setupUnifikasi();
        setupTerTab();
        setupDonasiTab();
    });
    </script>
</body>
</html>
